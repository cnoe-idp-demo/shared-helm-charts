apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.agentName }}-execution-role-script"
  namespace: "{{ .Values.agentName }}"
  labels:
    app: "{{ .Values.agentName }}"
    component: agentcore-deployment
data:
  agentcore-runtime-execution-role.sh: |
    #!/bin/bash

    ACCOUNT_ID="{{ .Values.agentcore.job.accountId }}"
    REGION="{{ .Values.agentcore.job.awsRegion }}"
    RANDOM_SUFFIX=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 6 | head -n 1)
    ROLE_NAME="AgentCoreExecutionRole-{{ .Values.agentName }}-${RANDOM_SUFFIX}"
    CONTAINER_REPO="*"

    # Create trust policy
    cat > /tmp/trust-policy.json << EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AssumeRolePolicy",
          "Effect": "Allow",
          "Principal": {
            "Service": "bedrock-agentcore.amazonaws.com"
          },
          "Action": "sts:AssumeRole",
          "Condition": {
            "StringEquals": {
              "aws:SourceAccount": "$ACCOUNT_ID"
            },
            "ArnLike": {
              "aws:SourceArn": "arn:aws:bedrock-agentcore:$REGION:$ACCOUNT_ID:*"
            }
          }
        }
      ]
    }
    EOF

    # Create permissions policy
    cat > /tmp/permissions-policy.json << EOF
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Sid": "ECRImageAccess",
                "Effect": "Allow",
                "Action": [
                    "ecr:BatchGetImage",
                    "ecr:GetDownloadUrlForLayer"
                ],
                "Resource": [
                    "arn:aws:ecr:$REGION:$ACCOUNT_ID:repository/$CONTAINER_REPO"
                ]
            },
            {
                "Sid": "ECRTokenAccess",
                "Effect": "Allow",
                "Action": [
                    "ecr:GetAuthorizationToken"
                ],
                "Resource": "*"
            },
            {
                "Effect": "Allow",
                "Action": [
                    "logs:DescribeLogStreams",
                    "logs:CreateLogGroup"
                ],
                "Resource": [
                    "arn:aws:logs:$REGION:$ACCOUNT_ID:log-group:/aws/bedrock-agentcore/runtimes/*"
                ]
            },
            {
                "Effect": "Allow",
                "Action": [
                    "logs:DescribeLogGroups"
                ],
                "Resource": [
                    "arn:aws:logs:$REGION:$ACCOUNT_ID:log-group:*"
                ]
            },
            {
                "Effect": "Allow",
                "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                ],
                "Resource": [
                    "arn:aws:logs:$REGION:$ACCOUNT_ID:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*"
                ]
            },
            {
                "Effect": "Allow",
                "Action": [
                    "xray:PutTraceSegments",
                    "xray:PutTelemetryRecords",
                    "xray:GetSamplingRules",
                    "xray:GetSamplingTargets"
                ],
                "Resource": ["*"]
            },
            {
                "Effect": "Allow",
                "Resource": "*",
                "Action": "cloudwatch:PutMetricData",
                "Condition": {
                    "StringEquals": {
                        "cloudwatch:namespace": "bedrock-agentcore"
                    }
                }
            },
            {
                "Sid": "BedrockModelInvocation",
                "Effect": "Allow",
                "Action": [
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream"
                ],
                "Resource": [
                    "arn:aws:bedrock:*::foundation-model/*",
                    "arn:aws:bedrock:$REGION:$ACCOUNT_ID:*"
                ]
            }
        ]
    }
    EOF

    # Create the role
    echo "Creating IAM role: $ROLE_NAME"
    aws iam create-role \
      --role-name $ROLE_NAME \
      --assume-role-policy-document file:///tmp/trust-policy.json \
      --description "Execution role for AgentCore Runtime" \
      --region $REGION

    # Attach permissions
    echo "Attaching permissions policy..."
    aws iam put-role-policy \
      --role-name $ROLE_NAME \
      --policy-name AgentCoreExecutionPermissions \
      --policy-document file:///tmp/permissions-policy.json \
      --region $REGION

    # Get and display the role ARN
    ROLE_ARN=$(aws iam get-role \
      --role-name $ROLE_NAME \
      --query 'Role.Arn' \
      --output text \
      --region $REGION)

    echo ""
    echo "âœ… Role created successfully!"
    echo "Role Name: $ROLE_NAME"
    echo "Role ARN: $ROLE_ARN"

    # Save role info for the next container
    echo "$ROLE_NAME" > /shared/role_name
    echo "$ROLE_ARN" > /shared/role_arn

    # Clean up temp files
    rm /tmp/trust-policy.json /tmp/permissions-policy.json
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.agentName }}-deployment-script"
  namespace: "{{ .Values.agentName }}"
  labels:
    app: "{{ .Values.agentName }}"
    component: agentcore-deployment
data:
  deploy-agentcore-runtime.sh: |
    #!/bin/bash

    # Configuration
    ACCOUNT_ID="{{ .Values.agentcore.job.accountId }}"
    REGION="{{ .Values.agentcore.job.awsRegion }}"
    CONTAINER_URI={{ .Values.agentcore.job.containerUri }}
    RANDOM_SUFFIX=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 6 | head -n 1)
    sleep 30
    # Resource names
    AGENT_RUNTIME_NAME="aip_{{ .Values.agentName }}_${RANDOM_SUFFIX}"

    # Get role ARN from init container
    if [ -f "/shared/role_arn" ]; then
        ROLE_ARN=$(cat /shared/role_arn)
        echo "âœ“ Using role ARN from init container: $ROLE_ARN"
    else
        echo "Looking for AgentCore execution role..."
        ROLE_ARN=$(aws iam list-roles \
          --output json | jq -r '.Roles[] | select(.RoleName | contains("AgentCoreExecutionRole-{{ .Values.agentName }}-")) | .Arn' | head -n 1)
    fi

    if [ -z "$ROLE_ARN" ] || [ "$ROLE_ARN" == "null" ]; then
        echo "âŒ Error: No AgentCore execution role found."
        echo "Please create the execution role first using create-agentcore-role.sh"
        exit 1
    fi

    echo "âœ“ Found execution role: $ROLE_ARN"
    echo ""

    # Step 1: Create Agent Runtime
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Step 1: Creating Agent Runtime..."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    RUNTIME_RESPONSE=$(aws bedrock-agentcore-control create-agent-runtime \
      --agent-runtime-name "$AGENT_RUNTIME_NAME" \
      --agent-runtime-artifact "{\"containerConfiguration\":{\"containerUri\":\"$CONTAINER_URI\"}}" \
      --role-arn "$ROLE_ARN" \
      --network-configuration '{"networkMode":"PUBLIC"}' \
      --protocol-configuration '{"serverProtocol":"HTTP"}' \
      --description "AgentCore Runtime deployment" \
      --region $REGION \
      --output json 2>&1)

    if [ $? -ne 0 ]; then
        echo "âŒ Failed to create agent runtime:"
        echo "$RUNTIME_RESPONSE"
        exit 1
    fi

    # Extract runtime details
    RUNTIME_ID=$(echo "$RUNTIME_RESPONSE" | jq -r '.agentRuntimeId')
    RUNTIME_ARN=$(echo "$RUNTIME_RESPONSE" | jq -r '.agentRuntimeArn')
    RUNTIME_STATUS=$(echo "$RUNTIME_RESPONSE" | jq -r '.status')

    echo "âœ“ Agent Runtime created successfully!"
    echo "  Runtime ID: $RUNTIME_ID"
    echo "  Runtime ARN: $RUNTIME_ARN"
    echo "  Status: $RUNTIME_STATUS"
    echo ""

    # Step 2: Wait for Runtime to be READY
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Step 2: Waiting for Runtime to become READY..."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    MAX_ATTEMPTS=60
    ATTEMPT=0
    while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
        STATUS_RESPONSE=$(aws bedrock-agentcore-control get-agent-runtime \
          --agent-runtime-id "$RUNTIME_ID" \
          --region $REGION \
          --output json 2>&1)
        
        if [ $? -eq 0 ]; then
            CURRENT_STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
            echo "  Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $CURRENT_STATUS"
            
            if [ "$CURRENT_STATUS" == "READY" ] || [ "$CURRENT_STATUS" == "ACTIVE" ]; then
                echo "âœ“ Runtime is now $CURRENT_STATUS!"
                break
            elif [ "$CURRENT_STATUS" == "FAILED" ]; then
                echo "âŒ Runtime creation failed!"
                echo "$STATUS_RESPONSE"
                exit 1
            fi
        fi
        
        ATTEMPT=$((ATTEMPT+1))
        if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            sleep 10
        fi
    done

    if [ "$CURRENT_STATUS" != "READY" ] && [ "$CURRENT_STATUS" != "ACTIVE" ]; then
        echo "âš ï¸  Timeout waiting for runtime to become READY. Current status: $CURRENT_STATUS"
        echo "You can check the status later with:"
        echo "aws bedrock-agentcore-control get-agent-runtime --agent-runtime-id $RUNTIME_ID --region $REGION"
        exit 1
    fi

    echo ""

    # Final Summary
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ðŸŽ‰ Deployment Complete!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ðŸ“‹ Summary:"
    echo "  Agent Runtime Name: $AGENT_RUNTIME_NAME"
    echo "  Runtime ID: $RUNTIME_ID"
    echo "  Runtime ARN: $RUNTIME_ARN"
    echo "  Status: $CURRENT_STATUS"
    echo "  Region: $REGION"

    # Save details to shared volume for potential retrieval
    cat > /shared/deployment-info.txt << EOF
    Agent Runtime Deployment Information
    =====================================
    Deployment Time: $(date)
    Random Suffix: $RANDOM_SUFFIX

    Runtime Details:
      Name: $AGENT_RUNTIME_NAME
      ID: $RUNTIME_ID
      ARN: $RUNTIME_ARN
      Status: $CURRENT_STATUS

    Container:
      URI: $CONTAINER_URI

    Role:
      ARN: $ROLE_ARN

    Region: $REGION
    EOF

    echo "ðŸ’¾ Deployment details saved to shared volume"